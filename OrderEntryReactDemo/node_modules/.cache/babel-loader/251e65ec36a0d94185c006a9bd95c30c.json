{"ast":null,"code":"import * as qrcode from 'qrcode';\nimport styleText from './styles';\nimport { fuel } from './fuel';\n\nclass Storage {\n  constructor(keyPrefix) {\n    this.keyPrefix = keyPrefix;\n  }\n\n  async write(key, data) {\n    localStorage.setItem(this.storageKey(key), data);\n  }\n\n  async read(key) {\n    return localStorage.getItem(this.storageKey(key));\n  }\n\n  async remove(key) {\n    localStorage.removeItem(this.storageKey(key));\n  }\n\n  storageKey(key) {\n    return `${this.keyPrefix}-${key}`;\n  }\n\n}\n\nexport default class BrowserTransport {\n  constructor(options = {}) {\n    this.options = options;\n    this.classPrefix = options.classPrefix || 'anchor-link';\n    this.injectStyles = !(options.injectStyles === false);\n    this.requestStatus = !(options.requestStatus === false);\n    this.fuelEnabled = options.disableGreymassFuel !== true;\n    this.storage = new Storage(options.storagePrefix || 'anchor-link');\n  }\n\n  closeModal() {\n    this.hide();\n\n    if (this.activeCancel) {\n      this.activeRequest = undefined;\n      this.activeCancel('Modal closed');\n      this.activeCancel = undefined;\n    }\n  }\n\n  setupElements() {\n    if (this.injectStyles && !this.styleEl) {\n      this.styleEl = document.createElement('style');\n      this.styleEl.type = 'text/css';\n      const css = styleText.replace(/%prefix%/g, this.classPrefix);\n      this.styleEl.appendChild(document.createTextNode(css));\n      document.head.appendChild(this.styleEl);\n    }\n\n    if (!this.containerEl) {\n      this.containerEl = this.createEl();\n      this.containerEl.className = this.classPrefix;\n\n      this.containerEl.onclick = event => {\n        if (event.target === this.containerEl) {\n          event.stopPropagation();\n          this.closeModal();\n        }\n      };\n\n      document.body.appendChild(this.containerEl);\n    }\n\n    if (!this.requestEl) {\n      let wrapper = this.createEl({\n        class: 'inner'\n      });\n      let closeButton = this.createEl({\n        class: 'close'\n      });\n\n      closeButton.onclick = event => {\n        event.stopPropagation();\n        this.closeModal();\n      };\n\n      this.requestEl = this.createEl({\n        class: 'request'\n      });\n      wrapper.appendChild(this.requestEl);\n      wrapper.appendChild(closeButton);\n      this.containerEl.appendChild(wrapper);\n    }\n  }\n\n  createEl(attrs) {\n    if (!attrs) attrs = {};\n    const el = document.createElement(attrs.tag || 'div');\n\n    if (attrs) {\n      for (const attr of Object.keys(attrs)) {\n        const value = attrs[attr];\n\n        switch (attr) {\n          case 'src':\n            el.setAttribute(attr, value);\n            break;\n\n          case 'tag':\n            break;\n\n          case 'text':\n            el.appendChild(document.createTextNode(value));\n            break;\n\n          case 'class':\n            el.className = `${this.classPrefix}-${value}`;\n            break;\n\n          default:\n            el.setAttribute(attr, value);\n        }\n      }\n    }\n\n    return el;\n  }\n\n  hide() {\n    if (this.containerEl) {\n      this.containerEl.classList.remove(`${this.classPrefix}-active`);\n    }\n\n    this.clearTimers();\n  }\n\n  show() {\n    if (this.containerEl) {\n      this.containerEl.classList.add(`${this.classPrefix}-active`);\n    }\n  }\n\n  async displayRequest(request) {\n    this.setupElements();\n    let sameDeviceRequest = request.clone();\n    sameDeviceRequest.setInfoKey('same_device', true);\n    sameDeviceRequest.setInfoKey('return_path', returnUrl());\n    let sameDeviceUri = sameDeviceRequest.encode(true, false);\n    let crossDeviceUri = request.encode(true, false);\n    const isIdentity = request.isIdentity();\n    const title = isIdentity ? 'Login' : 'Sign';\n    const subtitle = 'Scan the QR-code with your Anchor app.';\n    const qrEl = this.createEl({\n      class: 'qr'\n    });\n\n    try {\n      qrEl.innerHTML = await qrcode.toString(crossDeviceUri, {\n        margin: 0,\n        errorCorrectionLevel: 'L'\n      });\n    } catch (error) {\n      console.warn('Unable to generate QR code', error);\n    }\n\n    const linkEl = this.createEl({\n      class: 'uri'\n    });\n    const linkA = this.createEl({\n      tag: 'a',\n      href: crossDeviceUri,\n      text: 'Open Anchor app'\n    });\n    linkA.addEventListener('click', event => {\n      event.preventDefault();\n\n      if (navigator.userAgent.toLowerCase().indexOf('firefox') > -1) {\n        iframe.setAttribute('src', sameDeviceUri);\n      } else {\n        window.location.href = sameDeviceUri;\n      }\n    });\n    linkEl.appendChild(linkA);\n    const iframe = this.createEl({\n      class: 'wskeepalive',\n      src: 'about:blank',\n      tag: 'iframe'\n    });\n    linkEl.appendChild(iframe);\n    const infoEl = this.createEl({\n      class: 'info'\n    });\n    const infoTitle = this.createEl({\n      class: 'title',\n      tag: 'span',\n      text: title\n    });\n    const infoSubtitle = this.createEl({\n      class: 'subtitle',\n      tag: 'span',\n      text: subtitle\n    });\n    infoEl.appendChild(infoTitle);\n    infoEl.appendChild(infoSubtitle);\n    const actionEl = this.createEl({\n      class: 'actions'\n    });\n    actionEl.appendChild(qrEl);\n    actionEl.appendChild(linkEl);\n    let footnoteEl;\n\n    if (isIdentity) {\n      footnoteEl = this.createEl({\n        class: 'footnote',\n        text: \"Don't have Anchor? \"\n      });\n      const footnoteLink = this.createEl({\n        tag: 'a',\n        target: '_blank',\n        href: 'https://greymass.com/anchor',\n        text: 'Download Anchor app now'\n      });\n      footnoteEl.appendChild(footnoteLink);\n    } else {\n      footnoteEl = this.createEl({\n        class: 'footnote',\n        text: 'Anchor signing is brought to you by '\n      });\n      const footnoteLink = this.createEl({\n        tag: 'a',\n        target: '_blank',\n        href: 'https://greymass.com',\n        text: 'Greymass'\n      });\n      footnoteEl.appendChild(footnoteLink);\n    }\n\n    emptyElement(this.requestEl);\n    const logoEl = this.createEl({\n      class: 'logo'\n    });\n    this.requestEl.appendChild(logoEl);\n    this.requestEl.appendChild(infoEl);\n    this.requestEl.appendChild(actionEl);\n    this.requestEl.appendChild(footnoteEl);\n    this.show();\n  }\n\n  async showLoading() {\n    this.setupElements();\n    emptyElement(this.requestEl);\n    const infoEl = this.createEl({\n      class: 'info'\n    });\n    const infoTitle = this.createEl({\n      class: 'title',\n      tag: 'span',\n      text: 'Loading'\n    });\n    const infoSubtitle = this.createEl({\n      class: 'subtitle',\n      tag: 'span',\n      text: 'Preparing request...'\n    });\n    this.prepareStatusEl = infoSubtitle;\n    infoEl.appendChild(infoTitle);\n    infoEl.appendChild(infoSubtitle);\n    const logoEl = this.createEl({\n      class: 'logo loading'\n    });\n    this.requestEl.appendChild(logoEl);\n    this.requestEl.appendChild(infoEl);\n    this.show();\n  }\n\n  onRequest(request, cancel) {\n    this.activeRequest = request;\n    this.activeCancel = cancel;\n    this.displayRequest(request).catch(cancel);\n  }\n\n  onSessionRequest(session, request, cancel) {\n    if (session.metadata.sameDevice) {\n      request.setInfoKey('return_path', returnUrl());\n    }\n\n    if (session.type === 'fallback') {\n      this.onRequest(request, cancel);\n\n      if (session.metadata.sameDevice) {\n        // trigger directly on a fallback same-device session\n        window.location.href = request.encode();\n      }\n\n      return;\n    }\n\n    this.activeRequest = request;\n    this.activeCancel = cancel;\n    this.setupElements();\n    const timeout = session.metadata.timeout || 60 * 1000 * 2;\n    const deviceName = session.metadata.name;\n    const start = Date.now();\n    const infoTitle = this.createEl({\n      class: 'title',\n      tag: 'span',\n      text: 'Sign'\n    });\n\n    const updateCountdown = () => {\n      const timeLeft = timeout + start - Date.now();\n      const timeFormatted = timeLeft > 0 ? new Date(timeLeft).toISOString().substr(14, 5) : '00:00';\n      infoTitle.textContent = `Sign - ${timeFormatted}`;\n    };\n\n    this.countdownTimer = setInterval(updateCountdown, 500);\n    updateCountdown();\n    const infoEl = this.createEl({\n      class: 'info'\n    });\n    infoEl.appendChild(infoTitle);\n    let subtitle;\n\n    if (deviceName && deviceName.length > 0) {\n      subtitle = `Please open Anchor app on “${deviceName}” to review and sign the transaction.`;\n    } else {\n      subtitle = 'Please review and sign the transaction in the linked wallet.';\n    }\n\n    const infoSubtitle = this.createEl({\n      class: 'subtitle',\n      tag: 'span',\n      text: subtitle\n    });\n    infoEl.appendChild(infoSubtitle);\n    emptyElement(this.requestEl);\n    const logoEl = this.createEl({\n      class: 'logo'\n    });\n    this.requestEl.appendChild(logoEl);\n    this.requestEl.appendChild(infoEl);\n    this.show();\n\n    if (isAppleHandheld() && session.metadata.sameDevice) {\n      window.location.href = 'anchor://link';\n    }\n  }\n\n  clearTimers() {\n    if (this.closeTimer) {\n      clearTimeout(this.closeTimer);\n      this.closeTimer = undefined;\n    }\n\n    if (this.countdownTimer) {\n      clearTimeout(this.countdownTimer);\n      this.countdownTimer = undefined;\n    }\n  }\n\n  updatePrepareStatus(message) {\n    if (this.prepareStatusEl) {\n      this.prepareStatusEl.textContent = message;\n    }\n  }\n\n  async prepare(request, session) {\n    this.showLoading();\n\n    if (!this.fuelEnabled || !session || request.isIdentity()) {\n      // don't attempt to cosign id request or if we don't have a session attached\n      return request;\n    }\n\n    try {\n      const result = fuel(request, session, this.updatePrepareStatus.bind(this));\n      const timeout = new Promise(r => setTimeout(r, 3500)).then(() => {\n        throw new Error('Fuel API timeout after 3500ms');\n      });\n      return await Promise.race([result, timeout]);\n    } catch (error) {\n      console.info(`Not applying fuel (${error.message})`);\n    }\n\n    return request;\n  }\n\n  onSuccess(request) {\n    if (request === this.activeRequest) {\n      this.clearTimers();\n\n      if (this.requestStatus) {\n        this.setupElements();\n        const infoEl = this.createEl({\n          class: 'info'\n        });\n        const logoEl = this.createEl({\n          class: 'logo'\n        });\n        logoEl.classList.add('success');\n        const infoTitle = this.createEl({\n          class: 'title',\n          tag: 'span',\n          text: 'Success!'\n        });\n        const subtitle = request.isIdentity() ? 'Identity signed.' : 'Transaction signed.';\n        const infoSubtitle = this.createEl({\n          class: 'subtitle',\n          tag: 'span',\n          text: subtitle\n        });\n        infoEl.appendChild(infoTitle);\n        infoEl.appendChild(infoSubtitle);\n        emptyElement(this.requestEl);\n        this.requestEl.appendChild(logoEl);\n        this.requestEl.appendChild(infoEl);\n        this.show();\n        this.closeTimer = setTimeout(() => {\n          this.hide();\n        }, 1.5 * 1000);\n      } else {\n        this.hide();\n      }\n    }\n  }\n\n  onFailure(request, error) {\n    if (request === this.activeRequest && error['code'] !== 'E_CANCEL') {\n      this.clearTimers();\n\n      if (this.requestStatus) {\n        this.setupElements();\n        const infoEl = this.createEl({\n          class: 'info'\n        });\n        const logoEl = this.createEl({\n          class: 'logo'\n        });\n        logoEl.classList.add('error');\n        const infoTitle = this.createEl({\n          class: 'title',\n          tag: 'span',\n          text: 'Transaction error'\n        });\n        const infoSubtitle = this.createEl({\n          class: 'subtitle',\n          tag: 'span',\n          text: error.message || String(error)\n        });\n        infoEl.appendChild(infoTitle);\n        infoEl.appendChild(infoSubtitle);\n        emptyElement(this.requestEl);\n        this.requestEl.appendChild(logoEl);\n        this.requestEl.appendChild(infoEl);\n        this.show();\n      } else {\n        this.hide();\n      }\n    }\n  }\n\n}\n\nfunction emptyElement(el) {\n  while (el.firstChild) {\n    el.removeChild(el.firstChild);\n  }\n}\n\nconst returnUrlAlphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';\nconst returnUrlAlphabetLen = returnUrlAlphabet.length;\n/** Generate a return url with a random #fragment so mobile safari will redirect back w/o reload. */\n\nfunction returnUrl() {\n  let rv = window.location.href.split('#')[0] + '#';\n\n  for (let i = 0; i < 8; i++) {\n    rv += returnUrlAlphabet.charAt(Math.floor(Math.random() * returnUrlAlphabetLen));\n  }\n\n  return rv;\n}\n\nfunction isAppleHandheld() {\n  return /iP(ad|od|hone)/i.test(navigator.userAgent);\n}","map":{"version":3,"sources":["../src/index.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["import * as qrcode from 'qrcode';\nimport styleText from './styles';\nimport { fuel } from './fuel';\nclass Storage {\n    constructor(keyPrefix) {\n        this.keyPrefix = keyPrefix;\n    }\n    async write(key, data) {\n        localStorage.setItem(this.storageKey(key), data);\n    }\n    async read(key) {\n        return localStorage.getItem(this.storageKey(key));\n    }\n    async remove(key) {\n        localStorage.removeItem(this.storageKey(key));\n    }\n    storageKey(key) {\n        return `${this.keyPrefix}-${key}`;\n    }\n}\nexport default class BrowserTransport {\n    constructor(options = {}) {\n        this.options = options;\n        this.classPrefix = options.classPrefix || 'anchor-link';\n        this.injectStyles = !(options.injectStyles === false);\n        this.requestStatus = !(options.requestStatus === false);\n        this.fuelEnabled = options.disableGreymassFuel !== true;\n        this.storage = new Storage(options.storagePrefix || 'anchor-link');\n    }\n    closeModal() {\n        this.hide();\n        if (this.activeCancel) {\n            this.activeRequest = undefined;\n            this.activeCancel('Modal closed');\n            this.activeCancel = undefined;\n        }\n    }\n    setupElements() {\n        if (this.injectStyles && !this.styleEl) {\n            this.styleEl = document.createElement('style');\n            this.styleEl.type = 'text/css';\n            const css = styleText.replace(/%prefix%/g, this.classPrefix);\n            this.styleEl.appendChild(document.createTextNode(css));\n            document.head.appendChild(this.styleEl);\n        }\n        if (!this.containerEl) {\n            this.containerEl = this.createEl();\n            this.containerEl.className = this.classPrefix;\n            this.containerEl.onclick = (event) => {\n                if (event.target === this.containerEl) {\n                    event.stopPropagation();\n                    this.closeModal();\n                }\n            };\n            document.body.appendChild(this.containerEl);\n        }\n        if (!this.requestEl) {\n            let wrapper = this.createEl({ class: 'inner' });\n            let closeButton = this.createEl({ class: 'close' });\n            closeButton.onclick = (event) => {\n                event.stopPropagation();\n                this.closeModal();\n            };\n            this.requestEl = this.createEl({ class: 'request' });\n            wrapper.appendChild(this.requestEl);\n            wrapper.appendChild(closeButton);\n            this.containerEl.appendChild(wrapper);\n        }\n    }\n    createEl(attrs) {\n        if (!attrs)\n            attrs = {};\n        const el = document.createElement(attrs.tag || 'div');\n        if (attrs) {\n            for (const attr of Object.keys(attrs)) {\n                const value = attrs[attr];\n                switch (attr) {\n                    case 'src':\n                        el.setAttribute(attr, value);\n                        break;\n                    case 'tag':\n                        break;\n                    case 'text':\n                        el.appendChild(document.createTextNode(value));\n                        break;\n                    case 'class':\n                        el.className = `${this.classPrefix}-${value}`;\n                        break;\n                    default:\n                        el.setAttribute(attr, value);\n                }\n            }\n        }\n        return el;\n    }\n    hide() {\n        if (this.containerEl) {\n            this.containerEl.classList.remove(`${this.classPrefix}-active`);\n        }\n        this.clearTimers();\n    }\n    show() {\n        if (this.containerEl) {\n            this.containerEl.classList.add(`${this.classPrefix}-active`);\n        }\n    }\n    async displayRequest(request) {\n        this.setupElements();\n        let sameDeviceRequest = request.clone();\n        sameDeviceRequest.setInfoKey('same_device', true);\n        sameDeviceRequest.setInfoKey('return_path', returnUrl());\n        let sameDeviceUri = sameDeviceRequest.encode(true, false);\n        let crossDeviceUri = request.encode(true, false);\n        const isIdentity = request.isIdentity();\n        const title = isIdentity ? 'Login' : 'Sign';\n        const subtitle = 'Scan the QR-code with your Anchor app.';\n        const qrEl = this.createEl({ class: 'qr' });\n        try {\n            qrEl.innerHTML = await qrcode.toString(crossDeviceUri, {\n                margin: 0,\n                errorCorrectionLevel: 'L',\n            });\n        }\n        catch (error) {\n            console.warn('Unable to generate QR code', error);\n        }\n        const linkEl = this.createEl({ class: 'uri' });\n        const linkA = this.createEl({\n            tag: 'a',\n            href: crossDeviceUri,\n            text: 'Open Anchor app',\n        });\n        linkA.addEventListener('click', (event) => {\n            event.preventDefault();\n            if (navigator.userAgent.toLowerCase().indexOf('firefox') > -1) {\n                iframe.setAttribute('src', sameDeviceUri);\n            }\n            else {\n                window.location.href = sameDeviceUri;\n            }\n        });\n        linkEl.appendChild(linkA);\n        const iframe = this.createEl({\n            class: 'wskeepalive',\n            src: 'about:blank',\n            tag: 'iframe',\n        });\n        linkEl.appendChild(iframe);\n        const infoEl = this.createEl({ class: 'info' });\n        const infoTitle = this.createEl({ class: 'title', tag: 'span', text: title });\n        const infoSubtitle = this.createEl({ class: 'subtitle', tag: 'span', text: subtitle });\n        infoEl.appendChild(infoTitle);\n        infoEl.appendChild(infoSubtitle);\n        const actionEl = this.createEl({ class: 'actions' });\n        actionEl.appendChild(qrEl);\n        actionEl.appendChild(linkEl);\n        let footnoteEl;\n        if (isIdentity) {\n            footnoteEl = this.createEl({ class: 'footnote', text: \"Don't have Anchor? \" });\n            const footnoteLink = this.createEl({\n                tag: 'a',\n                target: '_blank',\n                href: 'https://greymass.com/anchor',\n                text: 'Download Anchor app now',\n            });\n            footnoteEl.appendChild(footnoteLink);\n        }\n        else {\n            footnoteEl = this.createEl({\n                class: 'footnote',\n                text: 'Anchor signing is brought to you by ',\n            });\n            const footnoteLink = this.createEl({\n                tag: 'a',\n                target: '_blank',\n                href: 'https://greymass.com',\n                text: 'Greymass',\n            });\n            footnoteEl.appendChild(footnoteLink);\n        }\n        emptyElement(this.requestEl);\n        const logoEl = this.createEl({ class: 'logo' });\n        this.requestEl.appendChild(logoEl);\n        this.requestEl.appendChild(infoEl);\n        this.requestEl.appendChild(actionEl);\n        this.requestEl.appendChild(footnoteEl);\n        this.show();\n    }\n    async showLoading() {\n        this.setupElements();\n        emptyElement(this.requestEl);\n        const infoEl = this.createEl({ class: 'info' });\n        const infoTitle = this.createEl({ class: 'title', tag: 'span', text: 'Loading' });\n        const infoSubtitle = this.createEl({\n            class: 'subtitle',\n            tag: 'span',\n            text: 'Preparing request...',\n        });\n        this.prepareStatusEl = infoSubtitle;\n        infoEl.appendChild(infoTitle);\n        infoEl.appendChild(infoSubtitle);\n        const logoEl = this.createEl({ class: 'logo loading' });\n        this.requestEl.appendChild(logoEl);\n        this.requestEl.appendChild(infoEl);\n        this.show();\n    }\n    onRequest(request, cancel) {\n        this.activeRequest = request;\n        this.activeCancel = cancel;\n        this.displayRequest(request).catch(cancel);\n    }\n    onSessionRequest(session, request, cancel) {\n        if (session.metadata.sameDevice) {\n            request.setInfoKey('return_path', returnUrl());\n        }\n        if (session.type === 'fallback') {\n            this.onRequest(request, cancel);\n            if (session.metadata.sameDevice) {\n                // trigger directly on a fallback same-device session\n                window.location.href = request.encode();\n            }\n            return;\n        }\n        this.activeRequest = request;\n        this.activeCancel = cancel;\n        this.setupElements();\n        const timeout = session.metadata.timeout || 60 * 1000 * 2;\n        const deviceName = session.metadata.name;\n        const start = Date.now();\n        const infoTitle = this.createEl({ class: 'title', tag: 'span', text: 'Sign' });\n        const updateCountdown = () => {\n            const timeLeft = timeout + start - Date.now();\n            const timeFormatted = timeLeft > 0 ? new Date(timeLeft).toISOString().substr(14, 5) : '00:00';\n            infoTitle.textContent = `Sign - ${timeFormatted}`;\n        };\n        this.countdownTimer = setInterval(updateCountdown, 500);\n        updateCountdown();\n        const infoEl = this.createEl({ class: 'info' });\n        infoEl.appendChild(infoTitle);\n        let subtitle;\n        if (deviceName && deviceName.length > 0) {\n            subtitle = `Please open Anchor app on “${deviceName}” to review and sign the transaction.`;\n        }\n        else {\n            subtitle = 'Please review and sign the transaction in the linked wallet.';\n        }\n        const infoSubtitle = this.createEl({ class: 'subtitle', tag: 'span', text: subtitle });\n        infoEl.appendChild(infoSubtitle);\n        emptyElement(this.requestEl);\n        const logoEl = this.createEl({ class: 'logo' });\n        this.requestEl.appendChild(logoEl);\n        this.requestEl.appendChild(infoEl);\n        this.show();\n        if (isAppleHandheld() && session.metadata.sameDevice) {\n            window.location.href = 'anchor://link';\n        }\n    }\n    clearTimers() {\n        if (this.closeTimer) {\n            clearTimeout(this.closeTimer);\n            this.closeTimer = undefined;\n        }\n        if (this.countdownTimer) {\n            clearTimeout(this.countdownTimer);\n            this.countdownTimer = undefined;\n        }\n    }\n    updatePrepareStatus(message) {\n        if (this.prepareStatusEl) {\n            this.prepareStatusEl.textContent = message;\n        }\n    }\n    async prepare(request, session) {\n        this.showLoading();\n        if (!this.fuelEnabled || !session || request.isIdentity()) {\n            // don't attempt to cosign id request or if we don't have a session attached\n            return request;\n        }\n        try {\n            const result = fuel(request, session, this.updatePrepareStatus.bind(this));\n            const timeout = new Promise((r) => setTimeout(r, 3500)).then(() => {\n                throw new Error('Fuel API timeout after 3500ms');\n            });\n            return await Promise.race([result, timeout]);\n        }\n        catch (error) {\n            console.info(`Not applying fuel (${error.message})`);\n        }\n        return request;\n    }\n    onSuccess(request) {\n        if (request === this.activeRequest) {\n            this.clearTimers();\n            if (this.requestStatus) {\n                this.setupElements();\n                const infoEl = this.createEl({ class: 'info' });\n                const logoEl = this.createEl({ class: 'logo' });\n                logoEl.classList.add('success');\n                const infoTitle = this.createEl({ class: 'title', tag: 'span', text: 'Success!' });\n                const subtitle = request.isIdentity() ? 'Identity signed.' : 'Transaction signed.';\n                const infoSubtitle = this.createEl({ class: 'subtitle', tag: 'span', text: subtitle });\n                infoEl.appendChild(infoTitle);\n                infoEl.appendChild(infoSubtitle);\n                emptyElement(this.requestEl);\n                this.requestEl.appendChild(logoEl);\n                this.requestEl.appendChild(infoEl);\n                this.show();\n                this.closeTimer = setTimeout(() => {\n                    this.hide();\n                }, 1.5 * 1000);\n            }\n            else {\n                this.hide();\n            }\n        }\n    }\n    onFailure(request, error) {\n        if (request === this.activeRequest && error['code'] !== 'E_CANCEL') {\n            this.clearTimers();\n            if (this.requestStatus) {\n                this.setupElements();\n                const infoEl = this.createEl({ class: 'info' });\n                const logoEl = this.createEl({ class: 'logo' });\n                logoEl.classList.add('error');\n                const infoTitle = this.createEl({\n                    class: 'title',\n                    tag: 'span',\n                    text: 'Transaction error',\n                });\n                const infoSubtitle = this.createEl({\n                    class: 'subtitle',\n                    tag: 'span',\n                    text: error.message || String(error),\n                });\n                infoEl.appendChild(infoTitle);\n                infoEl.appendChild(infoSubtitle);\n                emptyElement(this.requestEl);\n                this.requestEl.appendChild(logoEl);\n                this.requestEl.appendChild(infoEl);\n                this.show();\n            }\n            else {\n                this.hide();\n            }\n        }\n    }\n}\nfunction emptyElement(el) {\n    while (el.firstChild) {\n        el.removeChild(el.firstChild);\n    }\n}\nconst returnUrlAlphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';\nconst returnUrlAlphabetLen = returnUrlAlphabet.length;\n/** Generate a return url with a random #fragment so mobile safari will redirect back w/o reload. */\nfunction returnUrl() {\n    let rv = window.location.href.split('#')[0] + '#';\n    for (let i = 0; i < 8; i++) {\n        rv += returnUrlAlphabet.charAt(Math.floor(Math.random() * returnUrlAlphabetLen));\n    }\n    return rv;\n}\nfunction isAppleHandheld() {\n    return /iP(ad|od|hone)/i.test(navigator.userAgent);\n}\n//# sourceMappingURL=index.js.map"]},"metadata":{},"sourceType":"module"}