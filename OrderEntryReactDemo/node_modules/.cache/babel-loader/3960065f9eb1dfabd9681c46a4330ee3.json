{"ast":null,"code":"import _regeneratorRuntime from \"C:\\\\Users\\\\naman.chopra\\\\Git-Repo\\\\eosiodemo\\\\OrderEntryReactDemo\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/regenerator\";\nimport _asyncToGenerator from \"C:\\\\Users\\\\naman.chopra\\\\Git-Repo\\\\eosiodemo\\\\OrderEntryReactDemo\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/asyncToGenerator\";\nimport _classCallCheck from \"C:\\\\Users\\\\naman.chopra\\\\Git-Repo\\\\eosiodemo\\\\OrderEntryReactDemo\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/classCallCheck\";\nimport _createClass from \"C:\\\\Users\\\\naman.chopra\\\\Git-Repo\\\\eosiodemo\\\\OrderEntryReactDemo\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/createClass\";\nimport * as qrcode from 'qrcode';\nimport styleText from './styles';\nimport { fuel } from './fuel';\n\nvar Storage = /*#__PURE__*/function () {\n  function Storage(keyPrefix) {\n    _classCallCheck(this, Storage);\n\n    this.keyPrefix = keyPrefix;\n  }\n\n  _createClass(Storage, [{\n    key: \"write\",\n    value: function () {\n      var _write = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee(key, data) {\n        return _regeneratorRuntime.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                localStorage.setItem(this.storageKey(key), data);\n\n              case 1:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, this);\n      }));\n\n      function write(_x, _x2) {\n        return _write.apply(this, arguments);\n      }\n\n      return write;\n    }()\n  }, {\n    key: \"read\",\n    value: function () {\n      var _read = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee2(key) {\n        return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                return _context2.abrupt(\"return\", localStorage.getItem(this.storageKey(key)));\n\n              case 1:\n              case \"end\":\n                return _context2.stop();\n            }\n          }\n        }, _callee2, this);\n      }));\n\n      function read(_x3) {\n        return _read.apply(this, arguments);\n      }\n\n      return read;\n    }()\n  }, {\n    key: \"remove\",\n    value: function () {\n      var _remove = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee3(key) {\n        return _regeneratorRuntime.wrap(function _callee3$(_context3) {\n          while (1) {\n            switch (_context3.prev = _context3.next) {\n              case 0:\n                localStorage.removeItem(this.storageKey(key));\n\n              case 1:\n              case \"end\":\n                return _context3.stop();\n            }\n          }\n        }, _callee3, this);\n      }));\n\n      function remove(_x4) {\n        return _remove.apply(this, arguments);\n      }\n\n      return remove;\n    }()\n  }, {\n    key: \"storageKey\",\n    value: function storageKey(key) {\n      return \"\".concat(this.keyPrefix, \"-\").concat(key);\n    }\n  }]);\n\n  return Storage;\n}();\n\nvar BrowserTransport = /*#__PURE__*/function () {\n  function BrowserTransport() {\n    var options = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n\n    _classCallCheck(this, BrowserTransport);\n\n    this.options = options;\n    this.classPrefix = options.classPrefix || 'anchor-link';\n    this.injectStyles = !(options.injectStyles === false);\n    this.requestStatus = !(options.requestStatus === false);\n    this.fuelEnabled = options.disableGreymassFuel !== true;\n    this.storage = new Storage(options.storagePrefix || 'anchor-link');\n  }\n\n  _createClass(BrowserTransport, [{\n    key: \"closeModal\",\n    value: function closeModal() {\n      this.hide();\n\n      if (this.activeCancel) {\n        this.activeRequest = undefined;\n        this.activeCancel('Modal closed');\n        this.activeCancel = undefined;\n      }\n    }\n  }, {\n    key: \"setupElements\",\n    value: function setupElements() {\n      var _this = this;\n\n      if (this.injectStyles && !this.styleEl) {\n        this.styleEl = document.createElement('style');\n        this.styleEl.type = 'text/css';\n        var css = styleText.replace(/%prefix%/g, this.classPrefix);\n        this.styleEl.appendChild(document.createTextNode(css));\n        document.head.appendChild(this.styleEl);\n      }\n\n      if (!this.containerEl) {\n        this.containerEl = this.createEl();\n        this.containerEl.className = this.classPrefix;\n\n        this.containerEl.onclick = function (event) {\n          if (event.target === _this.containerEl) {\n            event.stopPropagation();\n\n            _this.closeModal();\n          }\n        };\n\n        document.body.appendChild(this.containerEl);\n      }\n\n      if (!this.requestEl) {\n        var wrapper = this.createEl({\n          class: 'inner'\n        });\n        var closeButton = this.createEl({\n          class: 'close'\n        });\n\n        closeButton.onclick = function (event) {\n          event.stopPropagation();\n\n          _this.closeModal();\n        };\n\n        this.requestEl = this.createEl({\n          class: 'request'\n        });\n        wrapper.appendChild(this.requestEl);\n        wrapper.appendChild(closeButton);\n        this.containerEl.appendChild(wrapper);\n      }\n    }\n  }, {\n    key: \"createEl\",\n    value: function createEl(attrs) {\n      if (!attrs) attrs = {};\n      var el = document.createElement(attrs.tag || 'div');\n\n      if (attrs) {\n        for (var _i = 0, _Object$keys = Object.keys(attrs); _i < _Object$keys.length; _i++) {\n          var attr = _Object$keys[_i];\n          var value = attrs[attr];\n\n          switch (attr) {\n            case 'src':\n              el.setAttribute(attr, value);\n              break;\n\n            case 'tag':\n              break;\n\n            case 'text':\n              el.appendChild(document.createTextNode(value));\n              break;\n\n            case 'class':\n              el.className = \"\".concat(this.classPrefix, \"-\").concat(value);\n              break;\n\n            default:\n              el.setAttribute(attr, value);\n          }\n        }\n      }\n\n      return el;\n    }\n  }, {\n    key: \"hide\",\n    value: function hide() {\n      if (this.containerEl) {\n        this.containerEl.classList.remove(\"\".concat(this.classPrefix, \"-active\"));\n      }\n\n      this.clearTimers();\n    }\n  }, {\n    key: \"show\",\n    value: function show() {\n      if (this.containerEl) {\n        this.containerEl.classList.add(\"\".concat(this.classPrefix, \"-active\"));\n      }\n    }\n  }, {\n    key: \"displayRequest\",\n    value: function () {\n      var _displayRequest = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee4(request) {\n        var sameDeviceRequest, sameDeviceUri, crossDeviceUri, isIdentity, title, subtitle, qrEl, linkEl, linkA, iframe, infoEl, infoTitle, infoSubtitle, actionEl, footnoteEl, footnoteLink, _footnoteLink, logoEl;\n\n        return _regeneratorRuntime.wrap(function _callee4$(_context4) {\n          while (1) {\n            switch (_context4.prev = _context4.next) {\n              case 0:\n                this.setupElements();\n                sameDeviceRequest = request.clone();\n                sameDeviceRequest.setInfoKey('same_device', true);\n                sameDeviceRequest.setInfoKey('return_path', returnUrl());\n                sameDeviceUri = sameDeviceRequest.encode(true, false);\n                crossDeviceUri = request.encode(true, false);\n                isIdentity = request.isIdentity();\n                title = isIdentity ? 'Login' : 'Sign';\n                subtitle = 'Scan the QR-code with your Anchor app.';\n                qrEl = this.createEl({\n                  class: 'qr'\n                });\n                _context4.prev = 10;\n                _context4.next = 13;\n                return qrcode.toString(crossDeviceUri, {\n                  margin: 0,\n                  errorCorrectionLevel: 'L'\n                });\n\n              case 13:\n                qrEl.innerHTML = _context4.sent;\n                _context4.next = 19;\n                break;\n\n              case 16:\n                _context4.prev = 16;\n                _context4.t0 = _context4[\"catch\"](10);\n                console.warn('Unable to generate QR code', _context4.t0);\n\n              case 19:\n                linkEl = this.createEl({\n                  class: 'uri'\n                });\n                linkA = this.createEl({\n                  tag: 'a',\n                  href: crossDeviceUri,\n                  text: 'Open Anchor app'\n                });\n                linkA.addEventListener('click', function (event) {\n                  event.preventDefault();\n\n                  if (navigator.userAgent.toLowerCase().indexOf('firefox') > -1) {\n                    iframe.setAttribute('src', sameDeviceUri);\n                  } else {\n                    window.location.href = sameDeviceUri;\n                  }\n                });\n                linkEl.appendChild(linkA);\n                iframe = this.createEl({\n                  class: 'wskeepalive',\n                  src: 'about:blank',\n                  tag: 'iframe'\n                });\n                linkEl.appendChild(iframe);\n                infoEl = this.createEl({\n                  class: 'info'\n                });\n                infoTitle = this.createEl({\n                  class: 'title',\n                  tag: 'span',\n                  text: title\n                });\n                infoSubtitle = this.createEl({\n                  class: 'subtitle',\n                  tag: 'span',\n                  text: subtitle\n                });\n                infoEl.appendChild(infoTitle);\n                infoEl.appendChild(infoSubtitle);\n                actionEl = this.createEl({\n                  class: 'actions'\n                });\n                actionEl.appendChild(qrEl);\n                actionEl.appendChild(linkEl);\n\n                if (isIdentity) {\n                  footnoteEl = this.createEl({\n                    class: 'footnote',\n                    text: \"Don't have Anchor? \"\n                  });\n                  footnoteLink = this.createEl({\n                    tag: 'a',\n                    target: '_blank',\n                    href: 'https://greymass.com/anchor',\n                    text: 'Download Anchor app now'\n                  });\n                  footnoteEl.appendChild(footnoteLink);\n                } else {\n                  footnoteEl = this.createEl({\n                    class: 'footnote',\n                    text: 'Anchor signing is brought to you by '\n                  });\n                  _footnoteLink = this.createEl({\n                    tag: 'a',\n                    target: '_blank',\n                    href: 'https://greymass.com',\n                    text: 'Greymass'\n                  });\n                  footnoteEl.appendChild(_footnoteLink);\n                }\n\n                emptyElement(this.requestEl);\n                logoEl = this.createEl({\n                  class: 'logo'\n                });\n                this.requestEl.appendChild(logoEl);\n                this.requestEl.appendChild(infoEl);\n                this.requestEl.appendChild(actionEl);\n                this.requestEl.appendChild(footnoteEl);\n                this.show();\n\n              case 41:\n              case \"end\":\n                return _context4.stop();\n            }\n          }\n        }, _callee4, this, [[10, 16]]);\n      }));\n\n      function displayRequest(_x5) {\n        return _displayRequest.apply(this, arguments);\n      }\n\n      return displayRequest;\n    }()\n  }, {\n    key: \"showLoading\",\n    value: function () {\n      var _showLoading = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee5() {\n        var infoEl, infoTitle, infoSubtitle, logoEl;\n        return _regeneratorRuntime.wrap(function _callee5$(_context5) {\n          while (1) {\n            switch (_context5.prev = _context5.next) {\n              case 0:\n                this.setupElements();\n                emptyElement(this.requestEl);\n                infoEl = this.createEl({\n                  class: 'info'\n                });\n                infoTitle = this.createEl({\n                  class: 'title',\n                  tag: 'span',\n                  text: 'Loading'\n                });\n                infoSubtitle = this.createEl({\n                  class: 'subtitle',\n                  tag: 'span',\n                  text: 'Preparing request...'\n                });\n                this.prepareStatusEl = infoSubtitle;\n                infoEl.appendChild(infoTitle);\n                infoEl.appendChild(infoSubtitle);\n                logoEl = this.createEl({\n                  class: 'logo loading'\n                });\n                this.requestEl.appendChild(logoEl);\n                this.requestEl.appendChild(infoEl);\n                this.show();\n\n              case 12:\n              case \"end\":\n                return _context5.stop();\n            }\n          }\n        }, _callee5, this);\n      }));\n\n      function showLoading() {\n        return _showLoading.apply(this, arguments);\n      }\n\n      return showLoading;\n    }()\n  }, {\n    key: \"onRequest\",\n    value: function onRequest(request, cancel) {\n      this.activeRequest = request;\n      this.activeCancel = cancel;\n      this.displayRequest(request).catch(cancel);\n    }\n  }, {\n    key: \"onSessionRequest\",\n    value: function onSessionRequest(session, request, cancel) {\n      if (session.metadata.sameDevice) {\n        request.setInfoKey('return_path', returnUrl());\n      }\n\n      if (session.type === 'fallback') {\n        this.onRequest(request, cancel);\n\n        if (session.metadata.sameDevice) {\n          // trigger directly on a fallback same-device session\n          window.location.href = request.encode();\n        }\n\n        return;\n      }\n\n      this.activeRequest = request;\n      this.activeCancel = cancel;\n      this.setupElements();\n      var timeout = session.metadata.timeout || 60 * 1000 * 2;\n      var deviceName = session.metadata.name;\n      var start = Date.now();\n      var infoTitle = this.createEl({\n        class: 'title',\n        tag: 'span',\n        text: 'Sign'\n      });\n\n      var updateCountdown = function updateCountdown() {\n        var timeLeft = timeout + start - Date.now();\n        var timeFormatted = timeLeft > 0 ? new Date(timeLeft).toISOString().substr(14, 5) : '00:00';\n        infoTitle.textContent = \"Sign - \".concat(timeFormatted);\n      };\n\n      this.countdownTimer = setInterval(updateCountdown, 500);\n      updateCountdown();\n      var infoEl = this.createEl({\n        class: 'info'\n      });\n      infoEl.appendChild(infoTitle);\n      var subtitle;\n\n      if (deviceName && deviceName.length > 0) {\n        subtitle = \"Please open Anchor app on \\u201C\".concat(deviceName, \"\\u201D to review and sign the transaction.\");\n      } else {\n        subtitle = 'Please review and sign the transaction in the linked wallet.';\n      }\n\n      var infoSubtitle = this.createEl({\n        class: 'subtitle',\n        tag: 'span',\n        text: subtitle\n      });\n      infoEl.appendChild(infoSubtitle);\n      emptyElement(this.requestEl);\n      var logoEl = this.createEl({\n        class: 'logo'\n      });\n      this.requestEl.appendChild(logoEl);\n      this.requestEl.appendChild(infoEl);\n      this.show();\n\n      if (isAppleHandheld() && session.metadata.sameDevice) {\n        window.location.href = 'anchor://link';\n      }\n    }\n  }, {\n    key: \"clearTimers\",\n    value: function clearTimers() {\n      if (this.closeTimer) {\n        clearTimeout(this.closeTimer);\n        this.closeTimer = undefined;\n      }\n\n      if (this.countdownTimer) {\n        clearTimeout(this.countdownTimer);\n        this.countdownTimer = undefined;\n      }\n    }\n  }, {\n    key: \"updatePrepareStatus\",\n    value: function updatePrepareStatus(message) {\n      if (this.prepareStatusEl) {\n        this.prepareStatusEl.textContent = message;\n      }\n    }\n  }, {\n    key: \"prepare\",\n    value: function () {\n      var _prepare = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee6(request, session) {\n        var result, timeout;\n        return _regeneratorRuntime.wrap(function _callee6$(_context6) {\n          while (1) {\n            switch (_context6.prev = _context6.next) {\n              case 0:\n                this.showLoading();\n\n                if (!(!this.fuelEnabled || !session || request.isIdentity())) {\n                  _context6.next = 3;\n                  break;\n                }\n\n                return _context6.abrupt(\"return\", request);\n\n              case 3:\n                _context6.prev = 3;\n                result = fuel(request, session, this.updatePrepareStatus.bind(this));\n                timeout = new Promise(function (r) {\n                  return setTimeout(r, 3500);\n                }).then(function () {\n                  throw new Error('Fuel API timeout after 3500ms');\n                });\n                _context6.next = 8;\n                return Promise.race([result, timeout]);\n\n              case 8:\n                return _context6.abrupt(\"return\", _context6.sent);\n\n              case 11:\n                _context6.prev = 11;\n                _context6.t0 = _context6[\"catch\"](3);\n                console.info(\"Not applying fuel (\".concat(_context6.t0.message, \")\"));\n\n              case 14:\n                return _context6.abrupt(\"return\", request);\n\n              case 15:\n              case \"end\":\n                return _context6.stop();\n            }\n          }\n        }, _callee6, this, [[3, 11]]);\n      }));\n\n      function prepare(_x6, _x7) {\n        return _prepare.apply(this, arguments);\n      }\n\n      return prepare;\n    }()\n  }, {\n    key: \"onSuccess\",\n    value: function onSuccess(request) {\n      var _this2 = this;\n\n      if (request === this.activeRequest) {\n        this.clearTimers();\n\n        if (this.requestStatus) {\n          this.setupElements();\n          var infoEl = this.createEl({\n            class: 'info'\n          });\n          var logoEl = this.createEl({\n            class: 'logo'\n          });\n          logoEl.classList.add('success');\n          var infoTitle = this.createEl({\n            class: 'title',\n            tag: 'span',\n            text: 'Success!'\n          });\n          var subtitle = request.isIdentity() ? 'Identity signed.' : 'Transaction signed.';\n          var infoSubtitle = this.createEl({\n            class: 'subtitle',\n            tag: 'span',\n            text: subtitle\n          });\n          infoEl.appendChild(infoTitle);\n          infoEl.appendChild(infoSubtitle);\n          emptyElement(this.requestEl);\n          this.requestEl.appendChild(logoEl);\n          this.requestEl.appendChild(infoEl);\n          this.show();\n          this.closeTimer = setTimeout(function () {\n            _this2.hide();\n          }, 1.5 * 1000);\n        } else {\n          this.hide();\n        }\n      }\n    }\n  }, {\n    key: \"onFailure\",\n    value: function onFailure(request, error) {\n      if (request === this.activeRequest && error['code'] !== 'E_CANCEL') {\n        this.clearTimers();\n\n        if (this.requestStatus) {\n          this.setupElements();\n          var infoEl = this.createEl({\n            class: 'info'\n          });\n          var logoEl = this.createEl({\n            class: 'logo'\n          });\n          logoEl.classList.add('error');\n          var infoTitle = this.createEl({\n            class: 'title',\n            tag: 'span',\n            text: 'Transaction error'\n          });\n          var infoSubtitle = this.createEl({\n            class: 'subtitle',\n            tag: 'span',\n            text: error.message || String(error)\n          });\n          infoEl.appendChild(infoTitle);\n          infoEl.appendChild(infoSubtitle);\n          emptyElement(this.requestEl);\n          this.requestEl.appendChild(logoEl);\n          this.requestEl.appendChild(infoEl);\n          this.show();\n        } else {\n          this.hide();\n        }\n      }\n    }\n  }]);\n\n  return BrowserTransport;\n}();\n\nexport { BrowserTransport as default };\n\nfunction emptyElement(el) {\n  while (el.firstChild) {\n    el.removeChild(el.firstChild);\n  }\n}\n\nvar returnUrlAlphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';\nvar returnUrlAlphabetLen = returnUrlAlphabet.length;\n/** Generate a return url with a random #fragment so mobile safari will redirect back w/o reload. */\n\nfunction returnUrl() {\n  var rv = window.location.href.split('#')[0] + '#';\n\n  for (var i = 0; i < 8; i++) {\n    rv += returnUrlAlphabet.charAt(Math.floor(Math.random() * returnUrlAlphabetLen));\n  }\n\n  return rv;\n}\n\nfunction isAppleHandheld() {\n  return /iP(ad|od|hone)/i.test(navigator.userAgent);\n}","map":{"version":3,"sources":["../src/index.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["import * as qrcode from 'qrcode';\nimport styleText from './styles';\nimport { fuel } from './fuel';\nclass Storage {\n    constructor(keyPrefix) {\n        this.keyPrefix = keyPrefix;\n    }\n    async write(key, data) {\n        localStorage.setItem(this.storageKey(key), data);\n    }\n    async read(key) {\n        return localStorage.getItem(this.storageKey(key));\n    }\n    async remove(key) {\n        localStorage.removeItem(this.storageKey(key));\n    }\n    storageKey(key) {\n        return `${this.keyPrefix}-${key}`;\n    }\n}\nexport default class BrowserTransport {\n    constructor(options = {}) {\n        this.options = options;\n        this.classPrefix = options.classPrefix || 'anchor-link';\n        this.injectStyles = !(options.injectStyles === false);\n        this.requestStatus = !(options.requestStatus === false);\n        this.fuelEnabled = options.disableGreymassFuel !== true;\n        this.storage = new Storage(options.storagePrefix || 'anchor-link');\n    }\n    closeModal() {\n        this.hide();\n        if (this.activeCancel) {\n            this.activeRequest = undefined;\n            this.activeCancel('Modal closed');\n            this.activeCancel = undefined;\n        }\n    }\n    setupElements() {\n        if (this.injectStyles && !this.styleEl) {\n            this.styleEl = document.createElement('style');\n            this.styleEl.type = 'text/css';\n            const css = styleText.replace(/%prefix%/g, this.classPrefix);\n            this.styleEl.appendChild(document.createTextNode(css));\n            document.head.appendChild(this.styleEl);\n        }\n        if (!this.containerEl) {\n            this.containerEl = this.createEl();\n            this.containerEl.className = this.classPrefix;\n            this.containerEl.onclick = (event) => {\n                if (event.target === this.containerEl) {\n                    event.stopPropagation();\n                    this.closeModal();\n                }\n            };\n            document.body.appendChild(this.containerEl);\n        }\n        if (!this.requestEl) {\n            let wrapper = this.createEl({ class: 'inner' });\n            let closeButton = this.createEl({ class: 'close' });\n            closeButton.onclick = (event) => {\n                event.stopPropagation();\n                this.closeModal();\n            };\n            this.requestEl = this.createEl({ class: 'request' });\n            wrapper.appendChild(this.requestEl);\n            wrapper.appendChild(closeButton);\n            this.containerEl.appendChild(wrapper);\n        }\n    }\n    createEl(attrs) {\n        if (!attrs)\n            attrs = {};\n        const el = document.createElement(attrs.tag || 'div');\n        if (attrs) {\n            for (const attr of Object.keys(attrs)) {\n                const value = attrs[attr];\n                switch (attr) {\n                    case 'src':\n                        el.setAttribute(attr, value);\n                        break;\n                    case 'tag':\n                        break;\n                    case 'text':\n                        el.appendChild(document.createTextNode(value));\n                        break;\n                    case 'class':\n                        el.className = `${this.classPrefix}-${value}`;\n                        break;\n                    default:\n                        el.setAttribute(attr, value);\n                }\n            }\n        }\n        return el;\n    }\n    hide() {\n        if (this.containerEl) {\n            this.containerEl.classList.remove(`${this.classPrefix}-active`);\n        }\n        this.clearTimers();\n    }\n    show() {\n        if (this.containerEl) {\n            this.containerEl.classList.add(`${this.classPrefix}-active`);\n        }\n    }\n    async displayRequest(request) {\n        this.setupElements();\n        let sameDeviceRequest = request.clone();\n        sameDeviceRequest.setInfoKey('same_device', true);\n        sameDeviceRequest.setInfoKey('return_path', returnUrl());\n        let sameDeviceUri = sameDeviceRequest.encode(true, false);\n        let crossDeviceUri = request.encode(true, false);\n        const isIdentity = request.isIdentity();\n        const title = isIdentity ? 'Login' : 'Sign';\n        const subtitle = 'Scan the QR-code with your Anchor app.';\n        const qrEl = this.createEl({ class: 'qr' });\n        try {\n            qrEl.innerHTML = await qrcode.toString(crossDeviceUri, {\n                margin: 0,\n                errorCorrectionLevel: 'L',\n            });\n        }\n        catch (error) {\n            console.warn('Unable to generate QR code', error);\n        }\n        const linkEl = this.createEl({ class: 'uri' });\n        const linkA = this.createEl({\n            tag: 'a',\n            href: crossDeviceUri,\n            text: 'Open Anchor app',\n        });\n        linkA.addEventListener('click', (event) => {\n            event.preventDefault();\n            if (navigator.userAgent.toLowerCase().indexOf('firefox') > -1) {\n                iframe.setAttribute('src', sameDeviceUri);\n            }\n            else {\n                window.location.href = sameDeviceUri;\n            }\n        });\n        linkEl.appendChild(linkA);\n        const iframe = this.createEl({\n            class: 'wskeepalive',\n            src: 'about:blank',\n            tag: 'iframe',\n        });\n        linkEl.appendChild(iframe);\n        const infoEl = this.createEl({ class: 'info' });\n        const infoTitle = this.createEl({ class: 'title', tag: 'span', text: title });\n        const infoSubtitle = this.createEl({ class: 'subtitle', tag: 'span', text: subtitle });\n        infoEl.appendChild(infoTitle);\n        infoEl.appendChild(infoSubtitle);\n        const actionEl = this.createEl({ class: 'actions' });\n        actionEl.appendChild(qrEl);\n        actionEl.appendChild(linkEl);\n        let footnoteEl;\n        if (isIdentity) {\n            footnoteEl = this.createEl({ class: 'footnote', text: \"Don't have Anchor? \" });\n            const footnoteLink = this.createEl({\n                tag: 'a',\n                target: '_blank',\n                href: 'https://greymass.com/anchor',\n                text: 'Download Anchor app now',\n            });\n            footnoteEl.appendChild(footnoteLink);\n        }\n        else {\n            footnoteEl = this.createEl({\n                class: 'footnote',\n                text: 'Anchor signing is brought to you by ',\n            });\n            const footnoteLink = this.createEl({\n                tag: 'a',\n                target: '_blank',\n                href: 'https://greymass.com',\n                text: 'Greymass',\n            });\n            footnoteEl.appendChild(footnoteLink);\n        }\n        emptyElement(this.requestEl);\n        const logoEl = this.createEl({ class: 'logo' });\n        this.requestEl.appendChild(logoEl);\n        this.requestEl.appendChild(infoEl);\n        this.requestEl.appendChild(actionEl);\n        this.requestEl.appendChild(footnoteEl);\n        this.show();\n    }\n    async showLoading() {\n        this.setupElements();\n        emptyElement(this.requestEl);\n        const infoEl = this.createEl({ class: 'info' });\n        const infoTitle = this.createEl({ class: 'title', tag: 'span', text: 'Loading' });\n        const infoSubtitle = this.createEl({\n            class: 'subtitle',\n            tag: 'span',\n            text: 'Preparing request...',\n        });\n        this.prepareStatusEl = infoSubtitle;\n        infoEl.appendChild(infoTitle);\n        infoEl.appendChild(infoSubtitle);\n        const logoEl = this.createEl({ class: 'logo loading' });\n        this.requestEl.appendChild(logoEl);\n        this.requestEl.appendChild(infoEl);\n        this.show();\n    }\n    onRequest(request, cancel) {\n        this.activeRequest = request;\n        this.activeCancel = cancel;\n        this.displayRequest(request).catch(cancel);\n    }\n    onSessionRequest(session, request, cancel) {\n        if (session.metadata.sameDevice) {\n            request.setInfoKey('return_path', returnUrl());\n        }\n        if (session.type === 'fallback') {\n            this.onRequest(request, cancel);\n            if (session.metadata.sameDevice) {\n                // trigger directly on a fallback same-device session\n                window.location.href = request.encode();\n            }\n            return;\n        }\n        this.activeRequest = request;\n        this.activeCancel = cancel;\n        this.setupElements();\n        const timeout = session.metadata.timeout || 60 * 1000 * 2;\n        const deviceName = session.metadata.name;\n        const start = Date.now();\n        const infoTitle = this.createEl({ class: 'title', tag: 'span', text: 'Sign' });\n        const updateCountdown = () => {\n            const timeLeft = timeout + start - Date.now();\n            const timeFormatted = timeLeft > 0 ? new Date(timeLeft).toISOString().substr(14, 5) : '00:00';\n            infoTitle.textContent = `Sign - ${timeFormatted}`;\n        };\n        this.countdownTimer = setInterval(updateCountdown, 500);\n        updateCountdown();\n        const infoEl = this.createEl({ class: 'info' });\n        infoEl.appendChild(infoTitle);\n        let subtitle;\n        if (deviceName && deviceName.length > 0) {\n            subtitle = `Please open Anchor app on “${deviceName}” to review and sign the transaction.`;\n        }\n        else {\n            subtitle = 'Please review and sign the transaction in the linked wallet.';\n        }\n        const infoSubtitle = this.createEl({ class: 'subtitle', tag: 'span', text: subtitle });\n        infoEl.appendChild(infoSubtitle);\n        emptyElement(this.requestEl);\n        const logoEl = this.createEl({ class: 'logo' });\n        this.requestEl.appendChild(logoEl);\n        this.requestEl.appendChild(infoEl);\n        this.show();\n        if (isAppleHandheld() && session.metadata.sameDevice) {\n            window.location.href = 'anchor://link';\n        }\n    }\n    clearTimers() {\n        if (this.closeTimer) {\n            clearTimeout(this.closeTimer);\n            this.closeTimer = undefined;\n        }\n        if (this.countdownTimer) {\n            clearTimeout(this.countdownTimer);\n            this.countdownTimer = undefined;\n        }\n    }\n    updatePrepareStatus(message) {\n        if (this.prepareStatusEl) {\n            this.prepareStatusEl.textContent = message;\n        }\n    }\n    async prepare(request, session) {\n        this.showLoading();\n        if (!this.fuelEnabled || !session || request.isIdentity()) {\n            // don't attempt to cosign id request or if we don't have a session attached\n            return request;\n        }\n        try {\n            const result = fuel(request, session, this.updatePrepareStatus.bind(this));\n            const timeout = new Promise((r) => setTimeout(r, 3500)).then(() => {\n                throw new Error('Fuel API timeout after 3500ms');\n            });\n            return await Promise.race([result, timeout]);\n        }\n        catch (error) {\n            console.info(`Not applying fuel (${error.message})`);\n        }\n        return request;\n    }\n    onSuccess(request) {\n        if (request === this.activeRequest) {\n            this.clearTimers();\n            if (this.requestStatus) {\n                this.setupElements();\n                const infoEl = this.createEl({ class: 'info' });\n                const logoEl = this.createEl({ class: 'logo' });\n                logoEl.classList.add('success');\n                const infoTitle = this.createEl({ class: 'title', tag: 'span', text: 'Success!' });\n                const subtitle = request.isIdentity() ? 'Identity signed.' : 'Transaction signed.';\n                const infoSubtitle = this.createEl({ class: 'subtitle', tag: 'span', text: subtitle });\n                infoEl.appendChild(infoTitle);\n                infoEl.appendChild(infoSubtitle);\n                emptyElement(this.requestEl);\n                this.requestEl.appendChild(logoEl);\n                this.requestEl.appendChild(infoEl);\n                this.show();\n                this.closeTimer = setTimeout(() => {\n                    this.hide();\n                }, 1.5 * 1000);\n            }\n            else {\n                this.hide();\n            }\n        }\n    }\n    onFailure(request, error) {\n        if (request === this.activeRequest && error['code'] !== 'E_CANCEL') {\n            this.clearTimers();\n            if (this.requestStatus) {\n                this.setupElements();\n                const infoEl = this.createEl({ class: 'info' });\n                const logoEl = this.createEl({ class: 'logo' });\n                logoEl.classList.add('error');\n                const infoTitle = this.createEl({\n                    class: 'title',\n                    tag: 'span',\n                    text: 'Transaction error',\n                });\n                const infoSubtitle = this.createEl({\n                    class: 'subtitle',\n                    tag: 'span',\n                    text: error.message || String(error),\n                });\n                infoEl.appendChild(infoTitle);\n                infoEl.appendChild(infoSubtitle);\n                emptyElement(this.requestEl);\n                this.requestEl.appendChild(logoEl);\n                this.requestEl.appendChild(infoEl);\n                this.show();\n            }\n            else {\n                this.hide();\n            }\n        }\n    }\n}\nfunction emptyElement(el) {\n    while (el.firstChild) {\n        el.removeChild(el.firstChild);\n    }\n}\nconst returnUrlAlphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';\nconst returnUrlAlphabetLen = returnUrlAlphabet.length;\n/** Generate a return url with a random #fragment so mobile safari will redirect back w/o reload. */\nfunction returnUrl() {\n    let rv = window.location.href.split('#')[0] + '#';\n    for (let i = 0; i < 8; i++) {\n        rv += returnUrlAlphabet.charAt(Math.floor(Math.random() * returnUrlAlphabetLen));\n    }\n    return rv;\n}\nfunction isAppleHandheld() {\n    return /iP(ad|od|hone)/i.test(navigator.userAgent);\n}\n//# sourceMappingURL=index.js.map"]},"metadata":{},"sourceType":"module"}